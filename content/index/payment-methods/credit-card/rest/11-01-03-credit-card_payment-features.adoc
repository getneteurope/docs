[#CreditCard_PaymentFeatures]
== Payment Features

[#CreditCard_PaymentFeatures_Tokenization]
=== Tokenization

[#CreditCard_PaymentFeatures_Tokenization_Introduction]
==== Introduction

Tokenization defines a process through which sensitive data, such as
credit card number, is replaced with a surrogate value known as a
"token". This token serves as a reference or surrogate value for the original credit card data.

Tokenization enables the merchant to use credit card data based on PCI
DSS regulations, during a payment process.

It is a service provided by _{payment-provider-name}_ for its customers. The token,
generated by _{payment-provider-name}_, reduces the merchant's PCI DSS Scope. That means,
merchants do not have to store sensitive primary account numbers.


There are two options of using tokenization:

.  *Sending a Credit Card Transaction with Credit Card Data*: +
{payment-gateway} takes the credit card data
and encrypts the data. These data are stored in a secured encrypted area
inside _{data-warehouse}_ and are for use only in the encrypted
state and secured environment. +
*In other words:* Every card number that accompanies a transaction in
{payment-gateway} is subsequently tokenized.
Regardless of the outcome of the transaction, any subsequent transaction
with these credit card data uses its assigned token instead of the clear
card account values. This means the merchant system never needs to store
the sensitive card information, helping to reduce PCI DSS compliance
issues.

. *Sending an Explicit Request with the Transaction Type _Tokenize_ or _Detokenize_*. +
A transaction with this transaction type encrypts or
decrypts credit card data for later reuse. The sender only gets back a
_token-ID_. This _token-ID_ can be reused many times as unique
identifier for this specific credit card without sending or storing
credit card data on shop side.
//-

What is the difference between these two options?

[cols="1,2"]
|===
|Sending a Credit Card Transaction with Credit Card Data |Sending an Explicit Request with the Transaction Type _tokenize_ or _detokenize_

|always initiates a payment process *and* encrypts credit card data |encrypts credit card data only
|  |*does not* initiate a payment process
|===

[#CreditCard_PaymentFeatures_Tokenization_TokenID]
==== The _token-id_

The merchant sends an initial request to _{payment-gateway}_.
This could be an _authorization_, for example. This request contains all
data concerning the goods, shipping etc, as well as the consumer's
credit card data. +

After the request of an _authorization_ transaction was processed
successfully, the response will not contain the information of the
Credit Card <data> tag. The <data> tag will be replaced with
a _token-id_ in the <card-token> tag. As soon as
the _token-id_ is created, the _token-id_ represents this
special credit card. +

With that _token-id_ any recurring or other follow up transaction
for this special credit card can be processed. As there is no additional
encryption required, the use of the _token-id_ reduces interaction
and accelerates the credit card payment process. Especially from PCI DSS
perspective, it is less critical. +

e.g. A _capture-authorization_ as follow up transaction in the workflow
does not need the <data> tag of the Credit Card but only the
_token-id_.

_When using credit card, {payment-gateway}_ offers two different
options to reference transactions. It depends on the merchant's
individual business needs and business processes, which type of
referencing should be used.

Look at the following table to understand the pros and cons of
referencing with a token or with the
<<GeneralPlatformFeatures_ReferencingTransaction, parent-transaction-id>>.

[cols="1,2,3"]
|===
| |_parent-transaction-id_ |_token-id_

.4+|Pro |Can be used for all alternative payment methods and _credit card_. |
       |Recurring transactions can always reference to a FIRST transaction. | Once created, the token can be reused as often as needed.
       |Referencing is possible to a previous transaction during the life cycle of a payment process. |Credit card check is only performed once (with the first transaction). Makes the payment process faster.
       |Reference is possible even on older transactions. |Reference is valid ad long as the _credit card_ is valid.
.2+|Con |Referencing only within one life cycle of a payment process. |Can only be used with _credit card_.
       |When used with _credit card_ all card checks have to be performed with every new transaction step. |If card has expired, new token will be needed, even if the card number remains the same.
|===


NOTE: When processing _credit card_ transactions, the merchant must be PCI DSS
compliant.

If the merchant only hands through a payment process (using a token) and
does not store card holder data, it reduces the merchant's applicable
controls required for PCI DSS validation.

If the merchant wants to store card holder data (using
``parent-transaction-id``), it increases the merchant's applicable controls
required for PCI DSS validation.

The following table describes, which data can be stored and which data
must not be stored to be PCI DSS compliant.

[cols="1,2,3,4,5"]
[%autowidth]
|===
2+| |Data Element |Storage permitted? |Data needs to be unreadable (in line with PCI DSS requirements)?
.7+|Account Data .4+|Card holder data |Primary Account Number (PAN) |YES |YES
                                      |Card holder name |YES |NO
                                      |Service code |YES |NO
                                      |Expiration date |YES |NO
                    .3+|Sensitive Authentication Data |Full track data |NO |Doesn't apply
                                                      |CAV2/CVC2/CVV2/CID |NO |Doesn't apply
                                                      |PIN/PIN Block |NO |Doesn't apply
|===


[#CreditCard_PaymentFeatures_Tokenization_TokenID_Referencing]
*Referencing by _token-id_*

Referencing based on a token can be performed by using the Field
``<token-id>``.

With that feature it is possible to refer a NEW transaction to an
already submitted initial transaction. In the initial transaction the
cluster of the ``<card>`` tag will be summarized in a _token-id_.
This _token-id_ will be used in any subsequent transaction, which is
based on this initial transaction. The _token-id_ can be seen as a
black box which guarantees a correct correlation of subsequent
transactions without transmitting the complete card data repeatedly.

[cols="1,2,3, 4, 5"]
[%autowidth]
|===
.2+h|Transaction Sequence .2+h|Transaction Type 2+h|Token-ID .2+h|<card-token>
                                                h|Token Definition h|Value

|Initial transaction (Request) |authorization |the ``<card>``-section and all its fields +
e.g.: ``<account-number>``, ``<expiration-month>``, etc +
obtains the substitute _token-id_ value
|1234567890987654 |empty
|Response on initial transaction |authorization 2+|uses _token-id_ value generated from ``<card>`` data given in the initial transaction |1234567890987654
|Any subsequent transaction of this initial transaction |purchase 2+|uses _token-id_ value generated from ``<card>`` data given in the initial transaction |1234567890987654
|===

See the
<<CreditCard_Samples_PaymentProcessUsingToken,samples for an overview of a payment process>>
consisting of the transaction
types _authorization_ and _purchase_ using a token.


[#CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard]
==== Tokenize a Credit Card

The transaction type _tokenize_ converts credit card information into a
token that can be used in subsequent payment transactions, instead of
the actual credit card information.

[#CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Workflow]
*Workflow*

image::images/11-01-03-credit-card_payment-features/Create_TokenID_Workflow.png[Create_TokenID_Workflow]


[#CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Fields]
*Fields*

The following fields must be sent either in the request or the response
(M = Mandatory, O = Optional). For details of the affected fields see
<<CC_Fields, the field table>>.

[col="1,2,3"]
|===
|Field |Request |Response

3+a|
[[CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Fields_payment]]
[discrete]
==== payment

|merchant-account-id |M |M
|transaction-id |M |
|request-id |M |M
|transaction-type |M |
|ip-address |O |

3+a|
[[CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Fields_statuses]]
[discrete]
==== statuses

|statuses.status | |M
|status@code | |M
|status@description | |M
|status@severity | |M

3+a|
[[CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Fields_accountHolder]]
[discrete]
==== account-holder

|account-holder.first-name |O |M
|account-holder.last-name |O |M
|account-holder.email |O |M
|account-holder.gender |O |M
|account-holder.date-of-birth |O |M
|account-holder.phone |O |M

3+a|
[[CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Fields_card]]
[discrete]
==== card

|card.account-number |M |
|card.expiration-month |M |
|card.expiration-year |O |
|card.card-type |M |

3+a|
[[CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Fields_cardToken]]
[discrete]
==== card-token

|card-token.token-id | |M
|card-token.token-ext-id | |O
|card-token.masked-account-number |O |
|===

[#CreditCard_PaymentFeatures_Tokenization_TokenizeCreditCard_Samples]
*Samples*

For transaction process details see the
<<CreditCard_Samples_Tokenization, _Tokenize_ samples>>.


[#CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard]
==== Detokenize a Credit Card

The transaction type _detokenize_ is the inverse of the transaction type
_tokenize._ With the transaction type _detokenize_ a _token-id_ is
provided to retrieve the original credit card information.

[#CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Fields]
*Fields*

The following fields must be sent either in the request or the response
(M = Mandatory, O = Optional). For details of the affected fields see
<<CC_Fields, the field table>>.

[col="1,2,3"]
|===
|Field |Request |Response

3+a|
[[CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Fields_payment]]
[discrete]
==== payment

|merchant-account-id |M |M
|transaction-id | |M
|request-id |M |M
|transaction-type | |M
|ip-address | |O

3+a|
[[CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Fields_statuses]]
[discrete]
==== statuses

|statuses.status | |M
|status@code | |M
|status@description | |M
|status@severity | |M

3+a|
[[CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Fields_accountHolder]]
[discrete]
==== account-holder

|account-holder.first-name |M |O
|account-holder.last-name |M |O
|account-holder.email |M |O
|account-holder.gender |M |O
|account-holder.date-of-birth |M |O
|account-holder.phone |M |O

3+a|
[[CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Fields_card]]
[discrete]
==== card

|card.account-number | |M
|card.expiration-month | |M
|card.expiration-year | |O
|card.card-type | |M

3+a|
[[CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Fields_cardToken]]
[discrete]
==== card-token

|card-token.token-id |M |M
|card-token.token-ext-id |O |O
|card-token.masked-account-number | |O
|===

[#CreditCard_PaymentFeatures_Tokenization_DetokenizeCreditCard_Samples]
*Samples*

For transaction process details see the
<<CreditCard_Samples_Detokenization, _detokenize_ samples>>.

NOTE: The transaction type _detokenize_ *is not included in default configuration.* +
For further information please contact: {e-mail-support}


[#CreditCard_PaymentFeatures_DynamicDescriptor]
=== Dynamic Descriptor

With the _Dynamic Descriptor_, merchants can itemize sales more clearly
to the benefit of their customers, back office and consumer care
management.

As merchants can add sales-specific information to electronic settlement
requests, consumers have a better understanding of what they purchased.
This increases their level of satisfaction and reduces the number of
chargebacks. Known as a dynamic descriptor, the details can be included
in any settlement transaction, be it e-commerce, POS or MOTO.

[#CreditCard_PaymentFeatures_DynamicDescriptor_DataStructure]
==== Data and Structure

_Merchant Name_ and _Merchant Location_ are usually displayed on the
cardholder's bank statement. These fields or parts of them are used for
presenting the dynamic data on the cardholder's statement.

Apart from such static data, the merchant can add transaction
information to better reference their sales. For example, the merchant
may use invoice number, booking ID or transaction ID. This data is
typically passed along to the merchant. As this field has a fixed
length, the longer the merchant name is, the smaller the number of
digits allocated to dynamic information will be.

[#CreditCard_PaymentFeatures_DynamicDescriptor_DataStructure_DigitsAllocation]
*Digits Allocation*

[cols="1,2,3"]
[%autowidth]
|===
|Card Brand |Field |Digits
.2+|VISA |Name |25
         |Location |13
.2+|Master Card |Name |22
                |Location |13
.2+|JCB |Name |25
        |Location |13
|===

NOTE: Merchants are advised to consider all these parameters before setting a
dynamic descriptor, because any text exceeding the permissible length is
cut off and discarded.

Please be aware that industry-specific restrictions apply by card
schemes.

Please also note that it is up to the issuer to decide which data
provided in the dynamic descriptor is printed on the cardholder's
statement. {payment-provider-name} can thus not guarantee that the dynamic descriptor
data submitted to the issuers via the scheme networks is fully printed
on the cardholder's statement.

{payment-provider-name} Bank (WDB) receives the transaction data from the {payment-gateway}, looks up the merchant address, consolidates static
address details and dynamic sales data (including _Merchant Name_ and
_Merchant Location_) and routes the information along with the
settlement request to the issuer. To what level the routed details will
later appear on the customer's card statement may vary from issuer to
issuer.


[#CreditCard_PaymentFeatures_DynamicDescriptor_HowItWorks]
==== How It Works

When a merchant sends a transaction request with a dynamic descriptor,
the data provided in the reserved transaction field tag expands the
address information registered in the card acquirer's MID database.

NOTE: The dynamic descriptor is created for settlement transaction types such
as ``purchase``, ``capture`` or ``credit``. ``authorization`` is not supported.

[#CreditCard_PaymentFeatures_DynamicDescriptor_HowItWorks_Workflow]
*Workflow*

image::images/11-01-03-credit-card_payment-features/CreditCard_DynamicDescriptor_Workflow.png[CreditCard DynamicDescriptor Workflow]


. The consumer shops at the merchant's site and enters his card
details at checkout.
. The merchant system records the data and posts an XML request
with the default identifiers including the descriptor text (entered in
one of the <Transaction-ID>, <Order Number>, <Request ID> or
<Descriptor> tag) to the {payment-gateway}.
. {payment-gateway} processes the request and forwards
the transaction details to the acquirer
(e.g. {payment-provider-name} Bank).
. The acquirer acquires the card and sales details, reads the
related identifier values, looks up the merchant's name and business
details in the MID database and complements the merchant data with the
data sent in one of the transaction identifier tag fields.
. The aquirer routes the settlement request including the
dynamic text to the issuer.
. The issuer processes the request, debits the consumer's
account and adds a new debit item with the dynamic descriptor to the
credit card statement.

//-

[#CreditCard_PaymentFeatures_PaymentFacilitator]
=== Payment Facilitator

The _Payment Facilitator_ model allows a Payment Service Provider with a
_Payment Facilitator_ license to aggregate credit card payments, collect
funds resulting from credit card traffic and settle sub merchants
directly.

Requests in _Payment Facilitator_ traffic require additional sub
merchant information in the
<<CC_Fields_xmlelements_request_submerchantinfo, ``sub-merchant-info``>>
tag of each first request in the transaction flow (e.g.
``check-enrollment``, ``authorization-only``, ``authorization`` or
``purchase``).

The sub merchant information is mandatory for MasterCard, Visa, UPI and JCB traffic.

NOTE: For each transaction flow the first request must contain ``sub-merchant-info``. For the following steps ``sub-merchant-info`` is not
mandatory. We recommend to send ``sub-merchant-info`` in every step. This avoids complexity in implementation.

For details contact <<ContactUs, Merchant Support>>.


[#CreditCard_PaymentFeatures_PaymentFacilitator_HowItWorks]
==== How It Works

image::images/11-01-03-credit-card_payment-features/Enable_payment_facilitator.png[CreditCard_PaymentFacilitator_Workflow]


See the
<<CreditCard_Samples_PaymentFacilitatorTransactions, corresponding samples for details>>.


[#CreditCard_PaymentFeatures_RecurringTransaction]
=== Recurring Transaction

To submit a
<<GeneralPlatformFeatures_Transactions_Recurring, recurring transaction>>
the merchant must submit a request with the transaction
type ``authorization-only``, ``authorization`` or ``purchase`` including
the
<<GeneralPlatformFeatures_Transactions_Recurring_Periodic, PERIODIC TYPE>>
element and a
<<GeneralPlatformFeatures_Transactions_Recurring_Sequence, SEQUENCE TYPE>>.

[#CreditCard_PaymentFeatures_RecurringTransaction_PeriodicTypes]
==== Credit Card specific _Periodic Types_

Aside from the standard _Periodic Types, Credit Card_ can also be used
with the _Periodic Types_ ``ucof`` and ``ci``.

[#CreditCard_PaymentFeatures_RecurringTransaction_PeriodicTypes_ucof]
*_ucof_*

_The Unscheduled Credential on File (ucof)_ allows the merchant to
reference a regularly based transaction (like an unlimited periodic
payment or an installment payment) to an already successfully submitted
transaction. ``ucof`` is a transaction using a stored credential for a
fixed or variable amount that does not occur on a scheduled or regularly
occurring transaction date, where the cardholder has provided consent
for the merchant to initiate one or more future transactions. An example
of such transaction is an account auto-top up transaction.

[#CreditCard_PaymentFeatures_RecurringTransaction_PeriodicTypes_ci]
*_ci_*

The periodic type ``ci`` (Consumer Initiated) allows the merchant to
identify that the cardholder himself initiated the transaction and
whether this is an initial (first) or subsequent (recurring) one. As
soon as this is subsequent merchant initiated transaction (e.g. the
cardholder used an account on merchant side ) and the corresponding
information is sent to _{payment-gateway},_ _CVV_ could be omitted
within the transaction and Visa will still approve it. So this will lead
to higher approve rate in the future.

[#CreditCard_PaymentFeatures_RecurringTransaction_Restrictions]
==== Restrictions

Read, which
<<GeneralPlatformFeatures_Transactions_Recurring_Restrictions, restrictions>>
have to be met to use a recurring transaction.

[#CreditCard_PaymentFeatures_RecurringTransaction_Samples]
==== Samples

See
<<CreditCard_Samples, request/response samples>> for _Recurring Transaction._

[#CreditCard_PaymentFeatures_RecurringTransaction_PossibleScenarios]
==== Possible Scenarios

[#CreditCard_PaymentFeatures_RecurringTransaction_PossibleScenarios_ShoppingOnline]
*Shopping Online/Via an App*

_Establish Stored Credential/First Transaction_

. Cardholder consent is obtained: ``merchant-tokenization-flag`` set
to ``true``
. Cardholder provides the Credit Card data including _CVV/CVC2_ code
(required): ``periodic/periodic-type = 'ci'`` included in the transaction
and ``periodic/sequence-type = 'first'``
. Merchant sends the transaction to {payment-gateway}

//-

.Example: Establishment of Stored Credential/First Transaction
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransactionPossibleScenariosShoppingOnline_CptCCdiCc.xml[]
----

_Subsequent Cardholder Initiated Purchase_

. Cardholder consent is obtained: ``merchant-tokenization-flag`` set
to ``true``
. Cardholder data is saved within a cardholder's account (_CVV_ is not
required)
. Cardholder uses the account to make a
purchase: ``periodic/periodic-type = 'ci'`` included in the transaction
and ``periodic/sequence-type = 'recurring'``
. Merchant sends the transaction to {payment-gateway}

//-

.Example: Subsequent Cardholder initiated purchase
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransactionPossibleScenariosShoppingOnline_CardholderUsesTheAccountToMakeA.xml[]
----

_Guest Account/Single Transaction_

. Since Cardholder doesn't create a account, Cardholder data is not
being saved: the default value for ``merchant-tokenization-flag`` is
``false``
. Cardholder provides the Credit Card data including _CVV/CVC2_ code
(required)
. Merchant sends the transaction to {payment-gateway}

//-

.Example: Guest account/single transaction
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransactionPossibleScenariosShoppingOnline_CptCCdiCc_3.xml[]
----

[#CreditCard_PaymentFeatures_RecurringTransaction_PossibleScenarios_RecurringInstallmentTransaction]
*Recurring \(R) or Installment (I) Transaction*

_First Recurring or Installment_

. Cardholder consent is obtained: ``merchant-tokenization-flag`` set
to ``true``
. Cardholder would like to initiate Recurring or Installment payments
. Cardholder provides the Credit Card data including _CVV/CVC2_
code: ``periodic/periodic-type = 'installment'``/``'recurring'`` included in
the transaction and ``periodic/sequence-type = 'first'``
. Merchant sends the transaction to {payment-gateway}

//-

.Example: First Recurring or Installment
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransactionPossibleScenariosRecurringInstallmentTransaction_CptCCdiC.xml[]
----

[#CreditCard_PaymentFeatures_RecurringTransaction_PossibleScenarios_SubsequentRecurringInstallment]
*Subsequent Recurring or Installment*

_Merchant Initiated Transaction_

. Merchant initiates a subsequent Recurring or Installment
payment: ``periodic/periodic-type = 'installment'``/``'recurring'`` included
in the transaction and ``periodic/sequence-type = 'recurring'``
. Merchant sends the transaction to {payment-gateway}

//-

.Example: Merchant initiated transaction
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransaction_SubsequentRecurringOrInstallment.xml[]
----

[#CreditCard_PaymentFeatures_RecurringTransaction_PossibleScenarios_ucof]
*ucof*

_Example_: auto-top up for transit or mobile - date is irregular, i.e.
not known as usage driven

. Cardholder consent is obtained: ``merchant-tokenization-flag`` set
to ``true``
. Cardholder would like to initiate _ucof_ payments
. Cardholder provides the Credit Card data including _CVV/CVC2_
code: ``periodic/periodic-type = 'ucof'`` included in the transaction
and ``periodic/sequence-type = 'first'``
. Merchant sends the transaction to {payment-gateway}

//-

.Example: First UCOF (sequence-type = 'first')
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransactionPossibleScenariosUcof_CptCCdiC.xml[]
----

_Merchant Initiated Transaction_

. Merchant initiates a subsequent UCOF
payment: ``periodic/periodic-type = 'ucof'``  included in the transaction
and ``periodic/sequence-type = 'recurring'``
. Merchant sends the transaction to {payment-gateway}

//-

.Example: Subsequent UCOF (sequence-type = 'recurring')
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CreditCardPaymentFeaturesRecurringTransactionPossibleScenariosUcof_MerchantInitiatesASubsequent_UCOF.xml[]
----

[#CreditCard_PaymentFeatures_RecurringTransactions_NonReferencedCapture]
==== Non-Referenced Capture

In an offline transaction process it is possible to have a
non-referenced capture authorization. The {payment-gateway} can
support such a type of transaction when using a special
``capture-authorization`` _Credit Card_ transaction.

A transaction is considered non-referenced capture when it meets all
the  following four conditions in the payment XML request:

. The transaction type is ``capture-authorization``
. ``payment-method`` is _Credit Card_
. ``parent-transaction-id`` is empty (no tag present)
. ``authorization-code`` is present (can have empty value)

//-

If all conditions are met, then the transaction is sent to {payment-gateway}.

The most exceptional fact in this process is, that it is missing the
_Parent-Transaction-ID_. By default ``capture-authorization`` takes most
of its properties from the parent transaction.

Even though no parent transaction is available, captures which have not
been referenced by {payment-gateway} can be processed. Cases
like this will be handled a non-referenced ``capture-authorization``
transaction type. In that case all fields must be supplied with the
_capture-authorization_ request.


[#CreditCard_PaymentFeatures_AccountUpdater]
===== Account Updater

Account Updater is a feature facilitating <<CreditCard_PaymentFeatures_RecurringTransaction, recurring>> credit card payments. It informs the merchant about changes of cardholders' credit card details.

It saves the cardholders the hassle of manually updating credit card details for each individual subscription. All types of recurring credit card payments can continue seamlessly even if

- the cardholder's credit card has expired.
- the cardholder has a new credit card.
//-

Furthermore, Account Updater informs the merchant when

- a credit card account is closed.
- the cardholder withdraws the authorization for their credit card to be charged.
- they need to contact the cardholder for clarification.
//-

NOTE: You must have an existing commercial agreement with the cardholder to receive these updates.

.Supported credit card brands:

- Visa
- Mastercard
//-

Account Updater also covers brand flips between these two.

.What is updated by Account Updater?

<<CreditCard_PaymentFeatures_RecurringTransaction, Recurring payments>> need a ``transaction-id`` of a preceding transaction to refer to (i.e. ``parent-transaction-id``). If credit card details change, Account Updater updates the corresponding ``transaction-id`` and returns the updated ``transaction-id`` to the merchant.

---

To activate and configure Account Updater, contact <<ContactUs, merchant support>>.

---

[#CreditCard_PaymentFeatures_AccountUpdater_Workflow]
====== Workflow

Updating account information requires action on the merchant side (step 1 and step 6):

image::images/11-01-03-credit-card_payment-features/Account_Updater_Workflow.png[Account Updater Workflow]

. Upload <<CreditCard_PaymentFeatures_AccountUpdater_Files_Request, request file>>:
.. Log in to the SFTP server with your SFTP credentials. If you do not have the appropriate URL or credentials, contact <<ContactUs, merchant support>>. +
.. Open folder ``FLIX``. If there is no ``FLIX`` folder, contact <<ContactUs, merchant support>>. +
The ``FLIX`` folder contains two customized subfolders: ``from ...`` and ``to ...``.
.. Open subfolder ``from ...``.
.. Open subfolder ``new``.
.. Upload the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Request, request file>> to the SFTP server.
. - 4. Account Updater retrieves the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Request, request file>> from the SFTP server and updates it with scheme data, which are continuously updated by the issuers. This may take up to 3 days.
//-

[start=5]
. Account Updater exports the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Response, response file>> to the ``FLIX``/``to ...``/``new`` subfolder and sends a notification email to the merchant.
. Log in to the SFTP server with your SFTP credentials. Open subfolder ``FLIX``/``to ...``/``new`` to download the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Response, response file>>.

//-

[#CreditCard_PaymentFeatures_AccountUpdater_Files]
====== Files

Both the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Request, request file>> and the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Response, response file>> are plain text files without extension.
The fields within the files are seperated by ``;``. All fields are mandatory, unless otherwise indicated.
Default encoding is UTF-8.

[#CreditCard_PaymentFeatures_AccountUpdater_Files_Request]
.Request File

The request file contains original ``transaction-id`` information.
The request file name must have a specific format:

image::images/11-01-03-credit-card_payment-features/Account_Updater_request_file_name.png[Account Updater request file name, width=79%, align=center]

e.g. AU.REQ.ID000000317588D017.D191015.S001

[#CreditCard_PaymentFeatures_AccountUpdater_Files_Request_Syntax]
*Request File Syntax:*

[underline]#Header line syntax (line 1):#

``H;MAID;batch-ID;email;Merchant Proprietary Info``

* ``H``: +
Indicates a header line.
* ``MAID``: +
Merchant Account ID
* ``batch-ID``: +
Internal merchant file ID used to match request and response files.
* ``email``: +
Once the response file is ready to be downloaded, or if the request file is invalid, Account Updater sends a notification email to the address entered here. +
The email address in the request file can differ from the default email address configured at Account Updater setup.
* ``Merchant Proprietary Info``: +
Optional field. Contains any information you want to be included in the request header. It will be mirrored in the response.
//-


[underline]#Detail lines syntax (records):#

``D;rfu;rfu;rfu;transacion-id;rfu;Merchant Proprietary Info Detail``

* ``D``: +
Indicates a detail line.
* ``rfu:`` +
Reserved for future use. Must be left blank.
* ``transaction-id``: +
Retrieved from an existing transaction. This ``transaction-id`` will be checked by Account Updater and supplemented with a new ``transaction-id`` if credit card details have changed.
* ``Merchant Proprietary Info Detail``: +
Optional field. Contains any information you want to be included in the record. It will be mirrored in the response.
//-

[#CreditCard_PaymentFeatures_AccountUpdater_Files_Request_Syntax_Footer]
[underline]#Footer line syntax (last line):#

``F;n``

* ``F``: +
Indicates a footer line.
* ``n``: +
Total number of lines (including header, details and footer).
//-

*Sample Request File (Success):*
[source,txt,subs=attributes+]
----
H;000000317588D017;123;notification.address@merchant.com;ProprietaryInformation for this batch
D;;;;C020929259567753216841;;proprietaryInfoa7e94047e4494f0698b4
D;;;;C057225169441625488387;;proprietaryInfodf2cfd1ce8c84b08bf25
D;;;;C073152725565823862026;;proprietaryInfo3ea5484f848f451488fc
D;;;;C081533725758083421254;;proprietaryInfo96d19d4010d14aabbc94
D;;;;C077647318514033592579;;proprietaryInfo2a5936061c984e14834c
F;7
----

*Sample Request File (Error):*
[source,txt,subs=attributes+]
----
H;6787AD3256EA;1234;notification.address@merchant.com;ProprietaryInformation for this batch
D;;;;;;ProprietaryInformation for this record
D;;;;C0992801501001007160912;;ProprietaryInformation for this record
F;4
----


[#CreditCard_PaymentFeatures_AccountUpdater_Files_Response]
.Response File

The response file has the same name as the corresponding request file, only with "REQ" replaced by "RES":
[.text-center]
*AU.[red]#RES#.ID<MAID>.D<YYMMDD>.S<3-digit seq #>*

It contains

* updated ``transaction-id`` information (i.e. information on credit card details changes) in case of success.
* response codes, describing the credit card details changes in case of success.
* error messages, describing the error reason (e.g. missing transaction-id) in case of failure.
//-

*Response File Syntax:*

[underline]#Header line syntax (line 1):#

``H;MAID;batch-ID;email;Merchant Proprietary Info``

* ``H``: +
Indicates a header line.
* ``MAID``: +
Merchant Account ID
* ``batch-ID``: +
Internal merchant file ID used to match request and response files.
* ``email``: +
Specified only in case of an error. +
* ``Merchant Proprietary Info``: +
Optional field. Contains any information you want to be included in the request header. It will be mirrored in the response.
//-

NOTE: If a record is invalid (e.g. invalid or missing ``transaction-id``), Account Updater creates a response error file that contains all invalid records (see <<#CreditCard_PaymentFeatures_AccountUpdater_ErrorHandling, error handling>>). In this case, the response error file header contains also the email address to which Account Updater sent the  notification that an error occured. +

[underline]#Detail lines syntax (records):#

``D;rfu;rfu;rfu;rfu;transacion-id;rfu;rfu;rfu;rfu;new-transaction-id;response-code;rfu;Merchant Proprietary-Info``

* ``D``: +
Indicates a detail line.
* ``rfu:`` +
Reserved for future use.
* ``transaction-id``: +
Retrieved from an existing transaction. This ``transaction-id`` will be checked by Account Updater and supplemented with the ``new-transaction-id`` if credit card details have changed.
* ``new-transaction-id``: +
New ``transaction-id`` retrieved from updated credit card details. Use this ``transaction-id`` to reference to in recurring payments.
* ``response-code``: +
  ** ``V``: Valid credit card. No changes.
  ** ``A``: Update: Match made, credit card replaced.
  ** ``C``: Contact: Match made, credit card canceled.
  ** ``E``: Expiry: Match made, expiration date updated.
  ** ``P``: Unknown VISA credit card number - participating BIN/issuer.
  ** ``N``: Unknown VISA credit card number - non-participating BIN/issuer.
  ** ``U``: Unknown Mastercard credit card number.
  ** ``Q``: Contact the cardholder for additional account information.
* ``Merchant Proprietary Info:`` +
Optional field.
Contains any information you want to be included in the record.
Mirrored from request.
//-

NOTE: If a record is invalid (e.g. missing ``transaction-id``), Account Updater does not return a ``response-code``. Instead, an ``error message`` is appended to the end of the line.

The footer has the same syntax as in the <<CreditCard_PaymentFeatures_AccountUpdater_Files_Request_Syntax_Footer, request file>>.

*Sample Response File (Success):*
[source,txt,subs=attributes+]
----
H;000000317588D017;123;ProprietaryInformation for this batch
D;;;;;C073152725565823862026;;;;C074539155801779830647;A;;proprietaryInfo3ea5484f848f451488fc
D;;;;;C020929259567753216841;;;;C074539155801779830647;A;;proprietaryInfoa7e94047e4494f0698b4
D;;;;;C081533725758083421254;;;;C074539155801779830647;E;;proprietaryInfo96d19d4010d14aabbc94
D;;;;;C077647318514033592579;;;;C074539155801779830647;C;;proprietaryInfo2a5936061c984e14834c
D;;;;;C057225169441625488387;;;;C074539155801779830647;A;;proprietaryInfodf2cfd1ce8c84b08bf25
F;7
----

*Sample Response File (Error):*
[source,txt,subs=attributes+]
----
H;6787AD3256EA;1234;notification.address@merchant.com;ProprietaryInformation for this batch
D;;;;;;ProprietaryInformation for this record;Missing transaction id
F;3
----

[#CreditCard_PaymentFeatures_AccountUpdater_ErrorHandling]
====== Error Handling
. **Invalid request file:** +
+
--
Invalid request files can not be processed. Account Updater copies invalid request files to the subfolder
/``FLIX``/``fromMerchant``/``error`` and sends an email notification to the email adress configured by merchant support or given in the request file header. +
 Possible reasons: +

  * invalid format
  * invalid header
  * invalid footer
  * invalid file name +

<<CreditCard_PaymentFeatures_AccountUpdater_Files_Request_Syntax, Click here for correct request file syntax>>.
--

. **Invalid or missing ``transaction-id``:** +
+
--
A ``transaction-id`` is invalid if it cannot be matched with a credit card number. +
If one or more ``transaction-id``s are invalid or missing, Account Updater

  * creates a response error file that contains all invalid records
  * saves it in /``FLIX``/``toMerchant``/``error``
  * sends an email notification to the email adress configured by merchant support or given in the request file header. +

Invalid records are marked accordingly in the response error file.

NOTE: Even if a request file contains invalid or missing ``transaction-id``s, records with valid ``transaction-id``s  are processed as normal, and you can retrieve a response success file from ``FLIX``/``to ...``/``new``.
--



[#CreditCard_PaymentFeatures_LoyaltyPrograms]
=== Loyalty Programs

Some schemes provide a loyalty program for your consumers. _Visa_'s program is called _Visa Offers Platform_ (VOP), _Mastercard_'s program is called _MastercardÂ® Card Linked Services_ (MCLS). With these loyalty programs you can enroll your consumers' cards and record their loyalty based on the expenses made with the enrolled card. Schemes convert the tracked expenses into loyalty points. You can check in with the platform and allow your consumers to redeem the collected loyalty points.

[#CreditCard_PaymentFeatures_LoyaltyPrograms_TransactionTypes]
==== Transaction Types

Enroll a card in the loyalty program with the transaction type _enrollment_.

NOTE: The transaction type _enrollment_ for loyalty programs may not be confused with the transaction type _check-enrollment_ for <<3DS2_checkenrollment, 3DS2 payment processes>>.

[#CreditCard_PaymentFeatures_LoyaltyPrograms_TestCredentials]
==== Test Credentials

[#CreditCard_PaymentFeatures_LoyaltyPrograms_TestCredentials_VOP]
[discrete]
._VOP_

|===
h|Endpoint  | ``\https://{test-instance-hostname}/engine/rest/payments/``
h|Merchant Account ID (MAID) | f82ea856-be50-4899-988d-697574df65f0
h|Username | 61613-VisaOffers
h|Password | woU6xxn17HhSi-
h|Secret Key | d40ec430-89eb-4c52-ba2c-98d9e8910fb3
|===

[#CreditCard_PaymentFeatures_LoyaltyPrograms_TestCredentials_MCLS]
[discrete]
._MCLS_

|===
h|Endpoint  | ``\https://{test-instance-hostname}/engine/rest/payments/``
h|Merchant Account ID (MAID) | 3a645860-9f9d-4846-83a3-aa3451f842c4
h|Username | 61613-MCRewards
h|Password | TqlXmquI8jB2 
h|Secret Key | ca0cd974-8523-4bba-8cca-0572f9f30c74
|===

[#CreditCard_PaymentFeatures_LoyaltyPrograms_TestCredentials_VOPMCLS]
[discrete]
._VOP_ and _MCLS_

|===
h|Endpoint  | ``\https://{test-instance-hostname}/engine/rest/payments/``
h|Merchant Account ID (MAID) | 2df5742a-ee65-4bf4-8a5a-8b23f960c3e7
h|Username | 61613-ShopBack
h|Password | 5WKJIj9UMbf9
h|Secret Key | 361c4cf1-b71b-4996-9c05-2d0eac7bfeb3
|===

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Workflow]
==== Workflow

.Enroll Card

Transaction type must be ``enrollment``.

. You send _Enroll Card_ request, either for <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_EnrollmentRequest, VOP>> or <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_EnrollmentRequest, MCLS>>.
. {payment-gateway} returns _Enroll Card_ <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_EnrollmentResponse, VOP>> or <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_EnrollmentResponse, MCLS>> response.

[NOTE]
====
If you want to enroll to the loyalty programs with <<CreditCard_PaymentFeatures_Tokenization, tokenized cards>>, you can send a tokenize request first. +
See the corresponding samples for <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_TokenizeRequest, VOP>> and <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_TokenizeRequest, MCLS>>.
====

//-

.Add Card (VOP only)

Card type must be ``visa`` and transaction type must be ``enrollment``.

. You send an Add Visa Card <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardRequest, request>>.
. {payment-gateway} returns an Add Visa Card <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardResponse, response>>.

[NOTE]
====
If you want to add a tokenized Visa card, you can send a <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardTokenizedRequest, tokenize request>> first. 
====

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Fields]
==== Fields

Most of the fields used for the loyalty programs are the same as the <<CC_Fields, Credit Card fields>>. +
Loyalty program specific field information is given here.

//-

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Fields_request]
===== Request

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Fields_request_payment]
.``payment.``

:listname: CreditCard_PaymentFeatures_LoyaltyPrograms_Fields

[cols="30m,6,9,7,48a"]
|===
| Field | <<APIRef_FieldDefs_Cardinality, M/O>> | <<APIRef_FieldDefs_DataTypes, Data Type>> | Size | Description

include::{root}/include/fields/rest_cc/request/req-payment.adoc[tag=loyalty-prog]

|===

//-

:!listname:

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Fields_request_accountholder]
.``account-holder.``

:listname: CreditCard_PaymentFeatures_LoyaltyPrograms_Fields

include::{root}/include/field-list-headers/rest_cc/request/req-account-holder.adoc[]

[cols="30m,6,9,7,48a"]
|===
| Field | <<APIRef_FieldDefs_Cardinality, M/O>> | <<APIRef_FieldDefs_DataTypes, Data Type>> | Size | Description

include::{root}/include/fields/rest_cc/request/req-account-holder.adoc[tag=loyalty-prog]

|===

//-

:!listname:

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Fields_request_loyaltycard]
.``loyalty-card.``

:listname: CreditCard_PaymentFeatures_LoyaltyPrograms_Fields

include::{root}/include/field-list-headers/rest_cc/request/req-loyalty-card.adoc[]

:!listname:

[cols="30m,6,9,7,48a"]
|===
|Field | <<APIRef_FieldDefs_Cardinality, M/O>> | <<APIRef_FieldDefs_DataTypes, Data Type>> |Size |Description

include::{root}/include/fields/rest_cc/request/req-loyalty-card.adoc[]

|===

//-

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Fields_response]
===== Response

[#CC_Fields_xmlelements_response_carddata]
.``card-data.``

include::{root}/include/field-list-headers/rest_cc/response/res-card-data.adoc[tag=loyalty-prog]

[cols="30m,9,7,48a"]
|===
|Field | <<APIRef_FieldDefs_DataTypes, Data Type>> |Size |Description

include::{root}/include/fields/rest_cc/response/res-card-data.adoc[]

|===

[#CC_Fields_xmlelements_response_loyaltycard]
.``loyalty-card.``

include::{root}/include/field-list-headers/rest_cc/response/res-loyalty-card.adoc[tag=loyalty-prog]

[cols="30m,9,7,48a"]
|===
|Field | <<APIRef_FieldDefs_DataTypes, Data Type>> |Size |Description

include::{root}/include/fields/rest_cc/response/res-loyalty-card.adoc[]

|===

//-

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples]
==== Samples

--
IMPORTANT: For a successful test use a new set of ``payment.card`` values in each VOP or MCLS request that has not been used before. +
For your convenience you can use this https://generator-credit-card.com[credit card generator] for Visa and Mastercard.
--

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_EnrollmentRequest]
.VOP _Enroll Card_ Request

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_Enrollment_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_EnrollmentResponse]
.VOP _Enroll Card_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_Enrollment_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardRequest]
.VOP _Add Card_ Request

--
IMPORTANT: In this test request you have to not only <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples, change the values for ``payment.card``>> but also for ``payment.loyalty-card.user-id``. You can change the ``user-id`` arbitrarily.
--

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_AddCard_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardResponse]
.VOP _Add Card_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_AddCard_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_TokenizeRequest]
.VOP _Tokenize_ Request

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_Tokenize_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_TokenizeResponse]
.VOP _Tokenize_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_Tokenize_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_TokenizedenrollmentRequest]
.VOP _Enroll Tokenized Card_ Request

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_TokenizedEnrollment_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_TokenizedenrollmentResponse]
.VOP _Enroll Tokenized Card_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_TokenizedEnrollment_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardTokenizedRequest]
.VOP _Add Tokenized Card_ Request

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_AddCardTokenized_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_VOP_AddCardTokenizedResponse]
.VOP _Add Tokenized Card_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_VOP_AddCardTokenized_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_EnrollmentRequest]
.MCLS _Enroll Card_ Request 

--
IMPORTANT: In this test request you have to not only <<CreditCard_PaymentFeatures_LoyaltyPrograms_Samples, change the values for ``payment.card``>> but also for ``payment.loyalty-card.user-id``. You can change the ``user-id`` arbitrarily.
--

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_MCLS_Enrollment_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_EnrollmentResponse]
.MCLS _Enroll Card_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_MCLS_Enrollment_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_TokenizeRequest]
.MCLS _Tokenize_ Request

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_MCLS_Tokenize_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_TokenizeResponse]
.MCLS _Tokenize_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_MCLS_Tokenize_response.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_EnrollwTokenRequest]
.MCLS _Enroll Tokenized Card_ Request

--
IMPORTANT: In this test request use the ``token-id`` you received in the MCLS _Tokenize_ Response and change the ``payment.loyalty-card.user-id``. You can change the ``user-id`` arbitrarily.
--

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_MCLS_EnrollwToken_request.xml[]
----

[#CreditCard_PaymentFeatures_LoyaltyPrograms_Samples_MCLS_EnrollwTokenResponse]
.MCLS _Enroll Tokenized Card_ Response

[source,xml,subs=attributes+]
----
include::{root}/samples/xml/CC_PaymentFeatures_LoyaltyPrograms_MCLS_EnrollwToken_response.xml[]
----

//-
