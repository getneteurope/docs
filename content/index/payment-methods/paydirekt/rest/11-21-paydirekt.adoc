[#paydirekt]
== REST API & {payment-page-v1}
_paydirekt_ is a type of <<PaymentMethods_PaymentMode_OnlineBankTransfer, Online Bank Transfer>>.

[#paydirekt_PaymentModeCountriesandCurrencies]
=== Countries and Currencies
[width=75%,cols="1h,3",stripes=none]
|===
| Countries    | Germany
| Currencies   | EUR
|===

[#paydirekt_CommunicationFormats]
=== Communication Formats
This table illustrates how _paydirekt_ notifications are encoded and
which formats and methods can be used for requests and responses.
[width=75%,stripes=none]
|===
.2+h| Requests/Responses | Format   | XML
                         | Methods  | POST, GET
   h| IPN Encodement   2+| Base64
|===

[#paydirekt_TransactionTypes]
=== Transaction Types

For <<Glossary_TransactionType, transaction type>> details look
at <<AppendixB,  Transaction Types>>.

[%autowidth, cols="e,"]
|===
| Transaction Type      | Link to the Sample

| authorization         | <<paydirekt_Samples_authorization, _authorization_ samples>>
| capture-authorization | <<paydirekt_Samples_capture, _capture_ samples>>
| debit                 | <<paydirekt_Samples_debit, _debit_ samples>>
| refund-request        | <<paydirekt_Samples_refund-request, _refund-request_ samples>>
|===

[#paydirekt_TestCredentials]
=== Test Credentials
|===
.2+h| URLs (Endpoints)             | For transaction types _authorization_ and _debit_                      | ``\https://{rest-api-test-apm-endpoint}``
                                   | For transaction types _capture_ and _refund-request_ | ``\https://{rest-api-test-endpoint}``
   h| Merchant Account ID (MAID) 2+| c7f465c6-7982-4a58-a878-66265e75db50
   h| Username                   2+| 16390-testing
   h| Password                   2+| 3!3013=D3fD8X7
   h| Secret Key                 2+| 30520cf9-8f5b-4b0b-9430-58a1223b79dc
|===

[#paydirekt_AdditionalTestCredentials]
.On _paydirekt_ Environment

[%autowidth,cols="h,"]
|===
| login    | WirecardPDExpress2
| password | WirecardPDExpress22$
|===

[#paydirekt_Workflow]
=== Workflow

image::images/diagrams/paydirekt_workflow.svg[paydirekt Workflow,height=250]

. Consumer selects _paydirekt._
. Merchant sends a payment request to _{payment-gateway-abbr}_.
. {payment-gateway-abbr} forwards the payment request to _paydirekt._
. _paydirekt_ initializes payment.
. _paydirekt_ sends payment result to _{payment-gateway-abbr}_.
. {payment-gateway-abbr} sends redirect URL to merchant.
. Merchant forwards redirect URL to consumer.
. Consumer authorizes the transaction in _paydirekt_ account.
. _paydirekt_ processes the transaction.
. _paydirekt_ sends success result to _{payment-gateway-abbr}_.
. {payment-gateway-abbr} forwards success result to merchant and sends consumer data to _paydirekt._
. Merchant redirects consumer to success landing page.
. Consumer receives the successful result from merchant.
. _paydirekt_ collects amount from consumer's account.

//-

[#paydirekt_Fields]
=== Fields

The following elements are mandatory *M*, optional *O* or conditional
*C* for a request/response/notification. If the respective cell is
empty, the field is disregarded or not sent.

[#paydirekt_Fields_authorization]
==== _authorization_

[%autowidth, cols="e,,,,,,a"]
|===
| Term                                     | Request  | Response | Notification  | Type         | Size | Description

| merchant-account-id                      | M        | M        | M             | String       | 36   | Unique identifier for a merchant account.
| transaction-id                           |          | M        | M             |              | 36   | The Transaction ID is the unique identifier for a transaction. It is generated by Wirecard.
| request-id                               | M        | M        | M             | String       | 150   | This is the identification number of the request. *It has to be unique for each request.*
| transaction-type                         | M        | M        | M             | String       | 22   | This is the type for a transaction. Must be ``authorization``.
| payment-methods/payment-method[@name]    | M        | M        | M             | String       | 9    | The name of the Payment Method is _paydirekt._ Must be _paydirekt._
| payment-methods/payment-method[@url]     |          | M        |               | String       |      | _paydirekt_ url  where the consumer is going to be redirected in order to confirm the payment.
| api-id                                   | O        | O        | M             | String       |      |
| requested-amount                         | M        | M        | M             | Decimal      | 7,2  | This is the amount of the transaction.
The amount of the decimal place is dependent of the currency. Minimum is 0.01. Maximum is 50000.
| requested-amount[@currency]              | M        | M        | M             | String       | 3    | _paydirekt_ supports *only EUR currency.* Must be ``EUR``.
| order-number                             | M        | M        | M             | String       | 20   | The order number from the merchant.
| order-items                              | O        | O        | O             | order-item[] |      | Basket items details
| order-items/order-item                   | O        | O        | O             | order-item   |      | Basket item detail
| order-items/order-item/name              | M        | M        | M             | String       | 256  | Basket item name. Mandatory for each instance of ``order-item``.
| order-items/order-item/quantity          | M        | M        | M             | Number       |      | Basket item quantity. Should be greater than zero. Mandatory for each instance of ``order-item``.
| order-items/order-item/amount            | M        | M        | M             | Decimal      | 12,3 | Basket item amount. Mandatory for each instance of ``order-item``.
| order-items/order-item/amount[@currency] | M        | M        | M             | String       | 3    | Basket item amount currency, must be ``EUR``.
| order-items/order-item/article-number    | O        | O        | O             | String       |      | Article number
| order-items/order-item/tax-rate          | O        | O        | O             | String       |      | Tax rate
| shipping                                 | M        | M        | M             | Shipping     |      | Shipping details

Only mandatory for *non*-express payment! In case of express, shipping
data shall not be set.

| shipping/first-name                      | M        | M        | M             | String       | 32   | Consumer's first name
| shipping/last-name                       | M        | M        | M             | String       | 32   | Consumer's last name
| shipping/address                         | M        | M        | M             | Address      |      | Consumer's shipping address details
| shipping/address/street1                 | M        | M        | M             | String       | 70   | Consumer's shipping address street 1
| shipping/address/city                    | M        | M        | M             | String       | 32   | Consumer's shipping address city
| shipping/address/country                 | M        | M        | M             | String       | 3    | Consumer's shipping address country
| shipping/address/postal-code             | M        | M        | M             | String       | 16   | Consumer's shipping address zip code
| transaction-state                        |          | M        | M             | String       | 7    | Transaction result status. Should be ``success`` or ``cancel`` or ``failed``.
| Statuses/status[@code]                   |          | M        | M             | String       |      | Transaction status code, e.g. ``201.0000``.
| statuses/status[@description]            |          | M        | M             | String       |      | Transaction status description
| statuses/status[@severity]               |          | M        | M             | String       |      | Transaction status severity. Should be ``information`` for successful transactions, ``error`` for failed transactions.
| completion-time-stamp                    |          | M        | M             | Date time    |      | Timestamp of the transaction
|===

[#paydirekt_Fields_debit]
==== _debit_

[%autowidth, cols="e,,,,,,a"]
|===
| Term                                     | Request  | Response | Notification  | Type         | Size | Description

| merchant-account-id                      | M        | M        | M             | String       | 36   | Unique identifier for a merchant account.
| transaction-id                           |          | M        | M             | String       | 36   | The Transaction ID is the unique identifier for a transaction. It is generated by Wirecard.
| request-id                               | M        | M        | M             | String       | 150   | This is the identification number of the request. *It has to be unique for each request.*
| transaction-type                         | M        | M        | M             | String       | 22   | This is the type for a transaction. Must be ``debit``.
| payment-methods/payment-method[@name]    | M        | M        | M             | String       | 9    | The name of the Payment Method is _paydirekt_. Must be ``paydirekt``.
| payment-methods/payment-method[@url]     |          | M        |               | String       |      | _paydirekt_ url  where the consumer is going to be redirected in order to confirm the payment.
| api-id                                   | O        | O        | M             | String       |      |
| requested-amount                         | M        | M        | M             | Decimal      | 7,2  | This is the amount of the transaction. The amount of the decimal place is dependent of the currency. Minimum is 0.01. Maximum is 50000.
| requested-amount[@currency]              | M        | M        | M             | String       | 3    | _paydirekt_ supports *only EUR currency.* Must be ``EUR``.
| order-number                             | M        | M        | M             | String       | 20   | The order number from the merchant.
| order-items                              | O        | O        | O             | order-item[] |      | Basket items details
| order-items/order-item                   | O        | O        | O             | order-item   |      | Basket item detail
| order-items/order-item/name              | M        | M        | M             | String       | 256  | Basket item name. Mandatory for each instance of ``order-item``.
| order-items/order-item/quantity          | M        | M        | M             | Number       |      | Basket item quantity. Should be greater than zero. Mandatory for each instance of ``order-item``.
| order-items/order-item/amount            | M        | M        | M             | Decimal      | 12,3 | Basket item amount. Mandatory for each instance of ``order-item``.
| order-items/order-item/amount[@currency] | M        | M        | M             | String       | 3    | Basket item amount currency, must be ``EUR``.
| order-items/order-item/article-number    | O        | O        | O             | String       |      | Article number
| order-items/order-item/tax-rate          | O        | O        | O             | String       |      | Tax rate
| shipping                                 | M        | M        | M             | Shipping     |      | Shipping details

Only mandatory for *non*-express payment! In case of express, shipping data shall not be set.

| shipping/first-name                      | M        | M        | M             | String       | 32   | Consumer's first name
| shipping/last-name                       | M        | M        | M             | String       | 32   | Consumer's last name
| shipping/address                         | M        | M        | M             | Address      |      | Consumer's shipping address details
| shipping/address/street1                 | M        | M        | M             | String       | 70   | Consumer's shipping address street 1
| shipping/address/city                    | M        | M        | M             | String       | 32   | Consumer's shipping address city
| shipping/address/country                 | M        | M        | M             | String       | 3    | Consumer's shipping address country
| shipping/address/postal-code             | M        |          | M             | String       | 16   | Consumer's shipping address zip code
| transaction-state                        |          | M        | M             | String       | 7    | Transaction result status. Should be ``success`` or ``cancel`` or ``failed``.
| Statuses/status[@code]                   |          | M        | M             | String       |      | Transaction status code, e.g. ``201.0000``.
| statuses/status[@description]            |          | M        | M             | String       |      | Transaction status description
| statuses/status[@severity]               |          | M        | M             | String       |      | Transaction status severity. Should be ``information`` for successful transactions, ``error`` for failed transactions.
| completion-time-stamp                    |          | M        | M             |Date time     |      | Timestamp of the transaction
|===

[#paydirekt_Fields_captureAuthorization_refundCapture_refundDebit]
==== _capture-authorization & refund-capture & refund-debit_

[%autowidth, cols="e,,,,,,a"]
|===
| Term                                     | Request  | Response | Notification  | Type         | Size | Description

| merchant-account-id                      | M        | M        | M             | String       | 36   | Unique identifier for a merchant account.
| transaction-id                           |          | M        | M             |              | 36   | The Transaction ID is the unique identifier for a transaction. It is generated by Wirecard.
| parent-transaction-id                    | M        | M        |               | String       | 36   |
| request-id                               | M        | M        | M             | String       | 150   | This is the identification number of the request. *It has to be unique for each request.*
| transaction-type                         | M        | M        | M             | String       | 22   | This is the type for a transaction. Must be ``capture-authorization`` or ``refund-request``.
| payment-methods/payment-method[@name]    | M        | M        | M             | String       | 9    | The name of the Payment Method is _paydirekt_. Must be ``paydirekt``.
| api-id                                   | O        | M        | M             | String       |      |
| requested-amount                         | M        | M        | M             | Decimal      | 7,2  | This is the amount of the transaction.

The amount of the decimal place is dependent of the currency. Minimum is 0.01. Maximum is 50000.

| requested-amount[@currency]              | M        | M        | M             | String       | 3    | _paydirekt_ supports *only EUR currency.* Must be ``EUR``.
| order-number                             |          | M        | M             | String       | 20   | The order number from the merchant.
| order-items                              |          | O        | O             | order-item   |      | Basket items details. Present if exists for parent transaction.
| order-items/order-item                   |          | O        | O             | order-item   |      | Basket item detail. Present if exists for parent transaction.
| order-items/order-item/name              |          | M        | M             | String       | 256  | Basket item name. Mandatory for each instance of ``order-item``.
| order-items/order-item/quantity          |          | M        | M             | Number       |      | Basket item quantity. Should be greater than zero. Mandatory for each instance of ``order-item``.
| order-items/order-item/amount            |          | M        | M             | Decimal      | 12,3 | Basket item amount. Mandatory for each instance of ``order-item``.
| order-items/order-item/amount[@currency] |          | M        | M             | String       | 3    | Basket item amount currency, Must be ``EUR``.
| order-items/order-item/article-number    |          | O        | O             | String       |      | Article number
| order-items/order-item/tax-rate          |          | O        | O             | String       |      | Tax rate
| shipping                                 |          | M        | M             | Shipping     |      | Shipping details

Only mandatory for *non*-express payment! In case of express, shipping data shall not be set.

| shipping/first-name                      |          | M        | M             | String       | 32   | Consumer's first name
| shipping/last-name                       |          | M        | M             | String       | 32   | Consumer's last name
| shipping/address                         |          | M        | M             | Address      |      | Consumer's shipping address details
| shipping/address/street1                 |          | M        | M             | String       | 70   | Consumer's shipping address street 1
| shipping/address/city                    |          | M        | M             | String       | 32   | Consumer's shipping address city
| shipping/address/country                 |          | M        | M             | String       | 3    | Consumer's shipping address country
| shipping/address/postal-code             |          | M        | M             | String       | 16   | Consumer's shipping address zip code
| transaction-state                        |          | M        | M             | String       | 7    | Transaction result status. Should be ``success`` or ``cancel`` or ``failed``.
| Statuses/status[@code]                   |          | M        | M             | String       |      | Transaction status code, e.g. ``201.0000``.
| statuses/status[@description]            |          | M        | M             | String       |      | Transaction status description
| statuses/status[@severity]               |          | M        | M             | String       |      | Transaction status severity. Should be ``information`` for successful transactions, ``error`` for failed transactions.
| completion-time-stamp                    |          | M        | M             | Date time    |      | Timestamp of the capture/refund transaction
| custom-fields/custom-field[@field-name='finalCapture'][@field-value]
                                           | O        | O        | O             | Boolean      |      | Final capture flag. If set to true the final capture will be created and no further capture will be possible.
|===

[#paydirekt_Features]
=== Features

[#paydirekt_ExpressCheckout]
==== EXPRESS Checkout

[#paydirekt_ExpressCheckout_TestCredentials]
===== Test Credentials

|===
h| URLs (Endpoints)             | For transaction types _authorization_ and _debit_.                     | ``\https://{rest-api-test-apm-endpoint}``
h| Merchant Account ID (MAID) 2+| 068793d9-3f5b-4028-89b8-00e26a8c540d
h| Merchant Account Name      2+| _paydirekt Express_ Test Merchant
h| Username                   2+| 16390-testing
h| Password                   2+| 3!3013=D3fD8X7
h| Secret Key                 2+| e39945d1-9f42-4f3e-b873-09201d7cc95e
|===

[#paydirekt_ExpressCheckout_AdditionalTestCredentials]
.On paydirekt Environment
[%autowidth, cols="h,"]
|===
| Login    | WirecardPDExpress2
| Password | WirecardPDExpress22$
|===

[#paydirekt_ExpressCheckout_Description]
===== Description

_paydirekt_ Express enables payments to be made, with the shipping
address being returned to the merchant. In this way, a purchase can be
made without consumers having to enter their address on the merchant
website or having to create a consumer account. To complete the payment
and conclusively confirm it, the execute link must be called up after
the consumer confirmation in the _paydirekt_ system. Here, the
consumer is typically redirected back to the shop and prompted to
confirm the merchant's general terms & conditions of business.

[#paydirekt_ExpressCheckout_Configuration]
===== Configuration

WARNING: There is no special flag to mark "Express" Checkout, this depends on
merchant's configuration.

image::images/11-21-paydirekt/paydirekt-express-checkout-workflow.png[paydirekt Express Checkout Workflow]

[#paydirekt_ProcessFlow]
===== Process Flow

. Consumer: Clicks _EXPRESS Checkout_ Button in the Shop.
. Shop-System: Calls the checkout endpoint and submits all relevant
order data to _paydirekt._ +
_paydirekt:_ Returns the _approve_" link (_paydirekt_ payment page) in
the API Response.
. Shop-System: Redirects the Consumer to the approve link (_paydirekt_
payment page).
. Consumer: Logs into his _paydirekt_ account on the _paydirekt_
payment page.
. _paydirekt_: Calls the shop-system's ``callbackUrlCheckDestinations``
endpoint (the shop-system must provide this callback) after the consumer
logs in and the shop-system provides all addresses available in the
consumer's _paydirekt_ account in that call. +
Shop-System: Uses the addresses submitted from _paydirekt_ and decides
which addresses are allowed as invoice and/or delivery address.
Furthermore the shop system needs to add the shipping options for each
address and return this in the answer to the callback call.
. _paydirekt_: Displays the default addresses on the payment
page (those addresses used most often by the consumer) along with the
shipping options (that _paydirekt_ received in step 5). +
. Consumer: Chooses one of the shipping addresses. Alternatively, the
consumer can choose any other address available in his/her _paydirekt_
account (they all have shipping options associated due to the callback).
The consumer may also add a new address. If the consumer adds a new
address, a callback is issued similar to step 5, sending the new address
to the merchant. Handling is the same as in step 5. +
_paydirekt_: While the consumer chooses a shipping option on the payment
page, Wirecard recalculates/updates the totalAmount in the shopping
cart.
. Consumer: Consumer clicks on the _Jetzt kaufen_ link on the payment
page.
. _paydirekt_: Redirects the user back to the shop (using the provided
redirect URLS) depending on the status of the Directsale/Order
actions.
. Shop-System: Queries (GET) the checkout. The checkout now contains
the addresses the consumer selected along with the shipping options. The
shop-system now has all relevant data.
. Shop-System: Shows the _Final Order_ screen and _Order Confirmation_
button (along with the data from step 10).
. Consumer: Clicks the _Order Confirmation_ button
. Shop-System: Internally flags/stores the order as _confirmed_ AND
sends the execute request to _paydirekt_ (for initiating all payment
processes = getting the money). +
_paydirekt_: Will return the status of the execute call.
. Shop-System: Depending on the Status of Step 13:
.. Show the "thank you page" and stores the payment information to the
order. Or
.. In case of an error, most likely presents the consumer with a page
to choose a different payment method.

//-

See <<paydirekt_Samples_ExpressCheckout_debit, _debit_ Request (Express Checkout)>> for a sample.

[#paydirekt_Samples]
=== Samples

Go to <<GeneralPlatformFeatures_IPN_NotificationExamples, Notification Examples>>, if you want to see corresponding notification samples.

[#paydirekt_Samples_authorization]
==== _authorization_

.authorization Request (Successful)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_authorization_request_success.xml[]
----

.authorization Response (Successful)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_authorization_response_success.xml[]
----

NOTE: In the following failure samples the failure is caused by a difference
between requested amount and the total amount of the merchandise in the
cart.

.authorization Request (Failed)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_authorization_request_.xml[]
----

.authorization Response (Failed)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_authorization_response_.xml[]
----

[#paydirekt_Samples_capture]
==== _capture_

.capture-authorization Request (Successful)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_capture-authorization_request_success_784e748d.xml[]
----

.capture-authorization Response (Successful)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_capture-authorization_response_success_784e748d.xml[]
----

.capture-authorization Request (Failed)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_capture-authorization_request__784e748d.xml[]
----

.capture-authorization Response (Failed)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_capture-authorization_response__784e748d.xml[]
----

[#paydirekt_Samples_debit]
==== _debit_

.debit Request (Successful)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_debit_request_success.xml[]
----

.debit Response (Successful)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_debit_response_success.xml[]
----

[#paydirekt_Samples_ExpressCheckout_debit]
==== _debit_ EXPRESS Checkout

.debit Request (Express Checkout)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_debit_request_.xml[]
----

.debit Response (Express Checkout)
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_debit_response_.xml[]
----

NOTE: An Express Checkout request is a regular request (e.g. a regular
<<paydirekt_Samples_debit, debit>>) which
does *not* include the shipping element or account-holder element. The
payment response is a normal response with an 'approve' link.

[NOTE]
====
The information about the Express Checkout transaction is available in
the response as soon as the consumer

. has chosen the shipping/billing addresses.
. has finalized the payment.
. has clicked on the 'approve' link.

//-
====

[#paydirekt_Samples_refund-request]
===== _refund-request_

.refund-request Request
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_refund-request_request.xml[]
----

.refund-request Response
[source,xml,subs=attributes+]
----
include::{root}/samples/xml/paydirekt_refund-request_response.xml[]
----

//-
